{% extends 'base.html' %}
{% load static %}

{% block title %}Search User to Edit{% endblock %}

{% block content %}
<div class="container mx-auto p-6 max-w-2xl">
    <div class="bg-white rounded-lg shadow-lg p-6">
        <h2 class="text-2xl font-semibold text-gray-800 mb-6 text-center">Search User to Edit</h2>

        <!-- Search Input -->
        <div class="mb-6">
            <input type="text" id="user-search" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Enter name or email ID">
        </div>

        <!-- Search Results -->
        <div id="search-results" class="mb-6">
            <!-- Results will be populated dynamically via AJAX -->
        </div>

        <!-- Back Button -->
        <div class="text-center">
            <a href="{% url 'users:admin_dashboard' %}" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                Back to Dashboard
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function() {
        // Base URL for edit_user view using a hardcoded dummy integer
        const dummyId = '0';
        let editUserBaseUrl = '{% url 'qualifications:edit_user' user_id=0 %}'.replace(dummyId, '');
        // Ensure no trailing slash
        editUserBaseUrl = editUserBaseUrl.replace(/\/+$/, '');
        console.log('editUserBaseUrl:', editUserBaseUrl); // Debug log

        $('#user-search').on('input', function() {
            const query = $(this).val().trim();
            if (query.length >= 2) { // Minimum 2 characters to trigger search
                $.ajax({
                    url: '{% url 'qualifications:search_users' %}',
                    type: 'GET',
                    data: { q: query },
                    success: function(response) {
                        console.log('Search response:', response); // Debug log
                        const resultsDiv = $('#search-results');
                        resultsDiv.empty();
                        if (response.users && response.users.length > 0) {
                            const ul = $('<ul class="border border-gray-300 rounded-lg divide-y divide-gray-200"></ul>');
                            response.users.forEach(function(user) {
                                const li = $(`
                                    <li class="p-4 hover:bg-gray-100 cursor-pointer">
                                        <a class="block">
                                            <strong>${user.full_name || 'No name provided'}</strong> (${user.email})
                                            <span class="text-sm text-gray-500">Roles: ${user.roles.join(', ')}</span>
                                        </a>
                                    </li>
                                `);
                                // Set href dynamically using base URL and user_business_id
                                li.find('a').attr('href', editUserBaseUrl + '/' + user.user_business_id + '/');
                                ul.append(li);
                            });
                            resultsDiv.append(ul);
                        } else {
                            resultsDiv.append('<p class="text-gray-600">No users found.</p>');
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Search error:', status, error); // Debug log
                        $('#search-results').html('<p class="text-red-600">An error occurred while searching.</p>');
                    }
                });
            } else {
                $('#search-results').empty();
            }
        });
    });
</script>
{% endblock %}