{% extends 'base.html' %}
{% load static %}

{% block title %}Edit User{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="bg-white p-6 rounded-lg shadow-md max-w-2xl mx-auto">
        <h1 class="text-2xl font-semibold text-gray-800 mb-6 text-center">Edit User: {{ user.email }}</h1>

        <!-- Display messages -->
        {% if messages %}
        <div class="mb-6 space-y-2">
            {% for message in messages %}
            <div class="p-4 rounded-lg {% if message.tags == 'success' %}bg-green-100 text-green-700{% elif message.tags == 'warning' %}bg-yellow-100 text-yellow-700{% else %}bg-red-100 text-red-700{% endif %}">
                {{ message }}
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- Edit Form -->
        <form method="POST" class="space-y-6">
            {% csrf_token %}
            {{ form.non_field_errors }}

            <!-- User Information -->
            <div>
                <h2 class="text-xl font-semibold text-gray-700 mb-4">User Information</h2>
                <div class="mb-4">
                    <label for="{{ form.email.id_for_label }}" class="block text-sm font-medium text-gray-700">{{ form.email.label }}</label>
                    <input type="email" name="{{ form.email.name }}" id="{{ form.email.id_for_label }}" value="{{ form.email.value|default_if_none:'' }}" class="mt-1 block w-full bg-gray-100 border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm py-2 px-3" required>
                    {% if form.email.errors %}
                    <p class="mt-1 text-sm text-red-600">{{ form.email.errors|join:", " }}</p>
                    {% endif %}
                </div>
                <div class="mb-4">
                    <label for="{{ form.full_name.id_for_label }}" class="block text-sm font-medium text-gray-700">{{ form.full_name.label }}</label>
                    <input type="text" name="{{ form.full_name.name }}" id="{{ form.full_name.id_for_label }}" value="{{ form.full_name.value|default_if_none:'' }}" class="mt-1 block w-full bg-gray-100 border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm py-2 px-3" required>
                    {% if form.full_name.errors %}
                    <p class="mt-1 text-sm text-red-600">{{ form.full_name.errors|join:", " }}</p>
                    {% endif %}
                </div>
            </div>

            <!-- Learner Information (if applicable) -->
            {% if form.has_learner_role %}
            <div>
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Learner Information</h2>
                <!-- Qualification -->
                <div class="mb-4">
                    <label for="{{ form.qualification.id_for_label }}" class="block text-sm font-medium text-gray-700">{{ form.qualification.label }}</label>
                    <select name="{{ form.qualification.name }}" id="{{ form.qualification.id_for_label }}" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm py-2 px-3" required>
                        <option value="">{{ form.qualification.field.empty_label }}</option>
                        {% for qual in form.qualification.field.queryset %}
                        <option value="{{ qual.id }}" {% if form.qualification.value == qual.id %}selected{% endif %}>{{ qual }}</option>
                        {% endfor %}
                    </select>
                    {% if form.qualification.errors %}
                    <p class="mt-1 text-sm text-red-600">{{ form.qualification.errors|join:", " }}</p>
                    {% endif %}
                </div>
                <!-- Assessor -->
                <div class="mb-4">
                    <label for="{{ form.assessor.id_for_label }}" class="block text-sm font-medium text-gray-700">{{ form.assessor.label }}</label>
                    <select name="{{ form.assessor.name }}" id="{{ form.assessor.id_for_label }}" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm py-2 px-3" required>
                        <option value="">{{ form.assessor.field.empty_label }}</option>
                        {% for assessor in form.assessor.field.queryset %}
                        <option value="{{ assessor.id }}" {% if form.assessor.value == assessor.id %}selected{% endif %}>{{ assessor }}</option>
                        {% endfor %}
                    </select>
                    {% if form.assessor.errors %}
                    <p class="mt-1 text-sm text-red-600">{{ form.assessor.errors|join:", " }}</p>
                    {% endif %}
                </div>
                <!-- IQA -->
                <div class="mb-4">
                    <label for="{{ form.iqa.id_for_label }}" class="block text-sm font-medium text-gray-700">{{ form.iqa.label }}</label>
                    <select name="{{ form.iqa.name }}" id="{{ form.iqa.id_for_label }}" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm py-2 px-3" required>
                        <option value="">{{ form.iqa.field.empty_label }}</option>
                        {% for iqa in form.iqa.field.queryset %}
                        <option value="{{ iqa.id }}" {% if form.iqa.value == iqa.id %}selected{% endif %}>{{ iqa }}</option>
                        {% endfor %}
                    </select>
                    {% if form.iqa.errors %}
                    <p class="mt-1 text-sm text-red-600">{{ form.iqa.errors|join:", " }}</p>
                    {% endif %}
                </div>
                <!-- Date of Birth -->
                <div class="mb-4">
                    <label for="{{ form.learner_dob.id_for_label }}" class="block text-sm font-medium text-gray-700">{{ form.learner_dob.label }}</label>
                    <input type="date" name="{{ form.learner_dob.name }}" id="{{ form.learner_dob.id_for_label }}" value="{{ form.learner_dob.value|date:'Y-m-d'|default_if_none:'' }}" class="mt-1 block w-full bg-gray-100 border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm py-2 px-3">
                    {% if form.learner_dob.errors %}
                    <p class="mt-1 text-sm text-red-600">{{ form.learner_dob.errors|join:", " }}</p>
                    {% endif %}
                </div>
                <!-- Batch # -->
                <div class="mb-4">
                    <label for="{{ form.learner_batch_number.id_for_label }}" class="block text-sm font-medium text-gray-700">{{ form.learner_batch_number.label }}</label>
                    <input type="text" name="{{ form.learner_batch_number.name }}" id="{{ form.learner_batch_number.id_for_label }}" value="{{ form.learner_batch_number.value|default_if_none:'' }}" class="mt-1 block w-full bg-gray-100 border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm py-2 px-3">
                    {% if form.learner_batch_number.errors %}
                    <p class="mt-1 text-sm text-red-600">{{ form.learner_batch_number.errors|join:", " }}</p>
                    {% endif %}
                </div>
                <!-- Disability -->
                <div class="mb-4">
                    <label for="{{ form.learner_disability.id_for_label }}" class="block text-sm font-medium text-gray-700">{{ form.learner_disability.label }}</label>
                    <input type="checkbox" name="{{ form.learner_disability.name }}" id="{{ form.learner_disability.id_for_label }}" {% if form.learner_disability.value %}checked{% endif %} class="mt-1 h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                    {% if form.learner_disability.errors %}
                    <p class="mt-1 text-sm text-red-600">{{ form.learner_disability.errors|join:", " }}</p>
                    {% endif %}
                </div>
                <!-- Address -->
                <div class="mb-4">
                    <label for="{{ form.learner_address.id_for_label }}" class="block text-sm font-medium text-gray-700">{{ form.learner_address.label }}</label>
                    <textarea name="{{ form.learner_address.name }}" id="{{ form.learner_address.id_for_label }}" rows="3" class="mt-1 block w-full bg-gray-100 border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm py-2 px-3">{{ form.learner_address.value|default_if_none:'' }}</textarea>
                    {% if form.learner_address.errors %}
                    <p class="mt-1 text-sm text-red-600">{{ form.learner_address.errors|join:", " }}</p>
                    {% endif %}
                </div>
                <!-- Phone Number -->
                <div class="mb-4">
                    <label for="{{ form.learner_phone_number.id_for_label }}" class="block text-sm font-medium text-gray-700">{{ form.learner_phone_number.label }}</label>
                    <input type="tel" name="{{ form.learner_phone_number.name }}" id="{{ form.learner_phone_number.id_for_label }}" value="{{ form.learner_phone_number.value|default_if_none:'' }}" placeholder="+1234567890" class="mt-1 block w-full bg-gray-100 border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm py-2 px-3">
                    {% if form.learner_phone_number.errors %}
                    <p class="mt-1 text-sm text-red-600">{{ form.learner_phone_number.errors|join:", " }}</p>
                    {% endif %}
                </div>
                <!-- Date of Registration -->
                <div class="mb-4">
                    <label for="{{ form.learner_date_of_registration.id_for_label }}" class="block text-sm font-medium text-gray-700">{{ form.learner_date_of_registration.label }}</label>
                    <input type="date" name="{{ form.learner_date_of_registration.name }}" id="{{ form.learner_date_of_registration.id_for_label }}" value="{{ form.learner_date_of_registration.value|date:'Y-m-d'|default_if_none:'' }}" class="mt-1 block w-full bg-gray-100 border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm py-2 px-3" required>
                    {% if form.learner_date_of_registration.errors %}
                    <p class="mt-1 text-sm text-red-600">{{ form.learner_date_of_registration.errors|join:", " }}</p>
                    {% endif %}
                </div>
                <!-- Country -->
                <div class="mb-4">
                    <label for="{{ form.learner_country.id_for_label }}" class="block text-sm font-medium text-gray-700">{{ form.learner_country.label }}</label>
                    <select name="{{ form.learner_country.name }}" id="{{ form.learner_country.id_for_label }}" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm py-2 px-3">
                        <option value="">{{ form.learner_country.field.choices.0.1 }}</option>
                        {% for code, name in form.learner_country.field.choices %}
                        {% if code %}
                        <option value="{{ code }}" {% if form.learner_country.value == code %}selected{% endif %}>{{ name }}</option>
                        {% endif %}
                        {% endfor %}
                    </select>
                    {% if form.learner_country.errors %}
                    <p class="mt-1 text-sm text-red-600">{{ form.learner_country.errors|join:", " }}</p>
                    {% endif %}
                </div>
                <!-- Ethnicity -->
                <div class="mb-4">
                    <label for="{{ form.learner_ethnicity.id_for_label }}" class="block text-sm font-medium text-gray-700">{{ form.learner_ethnicity.label }}</label>
                    <select name="{{ form.learner_ethnicity.name }}" id="{{ form.learner_ethnicity.id_for_label }}" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm py-2 px-3">
                        <option value="">Select an ethnicity</option>
                        {% for code, name in form.learner_ethnicity.field.choices %}
                        <option value="{{ code }}" {% if form.learner_ethnicity.value == code %}selected{% endif %}>{{ name }}</option>
                        {% endfor %}
                    </select>
                    {% if form.learner_ethnicity.errors %}
                    <p class="mt-1 text-sm text-red-600">{{ form.learner_ethnicity.errors|join:", " }}</p>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- Submit Button -->
            <div class="text-center space-x-4">
                <button type="submit" class="inline-flex justify-center py-2 px-6 text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    Save Changes
                </button>
                <a href="{% url 'qualifications:edit_user_search' %}" class="inline-flex justify-center py-2 px-6 text-sm font-medium rounded-md text-gray-700 bg-white border border-gray-300 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    Cancel
                </a>
            </div>
        </form>
    </div>
</div>

<!-- JavaScript for dynamic assessor and IQA population -->
{% if form.has_learner_role %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const qualificationSelect = document.getElementById('{{ form.qualification.id_for_label }}');
        const assessorSelect = document.getElementById('{{ form.assessor.id_for_label }}');
        const iqaSelect = document.getElementById('{{ form.iqa.id_for_label }}');

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        qualificationSelect.addEventListener('change', function () {
            const qualId = this.value;
            if (qualId) {
                // Fetch assessors
                fetch('/qualifications/get_assessors/?qualification=' + qualId, {
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken')
                    }
                })
                .then(response => response.json())
                .then(data => {
                    assessorSelect.innerHTML = '<option value="">{{ form.assessor.field.empty_label }}</option>';
                    data.assessors.forEach(assessor => {
                        const option = document.createElement('option');
                        option.value = assessor.id;
                        option.text = assessor.name;
                        assessorSelect.appendChild(option);
                    });
                })
                .catch(error => console.error('Error fetching assessors:', error));

                // Fetch IQAs
                fetch('/qualifications/get_iqas/?qualification=' + qualId, {
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken')
                    }
                })
                .then(response => response.json())
                .then(data => {
                    iqaSelect.innerHTML = '<option value="">{{ form.iqa.field.empty_label }}</option>';
                    data.iqas.forEach(iqa => {
                        const option = document.createElement('option');
                        option.value = iqa.id;
                        option.text = iqa.name;
                        iqaSelect.appendChild(option);
                    });
                })
                .catch(error => console.error('Error fetching IQAs:', error));
            } else {
                assessorSelect.innerHTML = '<option value="">{{ form.assessor.field.empty_label }}</option>';
                iqaSelect.innerHTML = '<option value="">{{ form.iqa.field.empty_label }}</option>';
            }
        });

        // Trigger change event on page load to populate assessor/IQA
        if (qualificationSelect.value) {
            qualificationSelect.dispatchEvent(new Event('change'));
        }
    });
</script>
{% endif %}
{% endblock %}