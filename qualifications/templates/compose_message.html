{% extends 'base.html' %}
{% load static %}

{% block title %}Compose Message - AssessEEZ{% endblock %}

{% block nav_title %}Compose Message{% endblock %}

{% block nav_items %}
    <a href="{% url 'qualifications:inbox' %}" class="bg-blue-500 hover:bg-blue-600 px-4 py-2 rounded text-white">Back to Messages</a>
{% endblock %}

{% block content %}
    <div class="container mx-auto p-6 max-w-7xl">
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-2xl font-semibold text-gray-800 mb-6 text-center">Compose Message</h2>
            {% if messages %}
                <div class="mb-6">
                    {% for message in messages %}
                        <div class="p-4 rounded-lg {% if message.tags == 'success' %}bg-green-100 text-green-700{% else %}bg-red-100 text-red-700{% endif %}">
                            {{ message }}
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
            {% if form.errors %}
                <div class="mb-6 p-4 rounded-lg bg-red-100 text-red-700">
                    <p>Please correct the following errors:</p>
                    <ul>
                        {% for field in form %}
                            {% for error in field.errors %}
                                <li>{{ field.label }}: {{ error }}</li>
                            {% endfor %}
                        {% endfor %}
                        {% for error in form.non_field_errors %}
                            <li>{{ error }}</li>
                        {% endfor %}
                    </ul>
                </div>
            {% endif %}
            <form method="post" enctype="multipart/form-data" class="space-y-6" id="compose-message-form">
                {% csrf_token %}
                {% if is_reply %}
                    <div class="bg-gray-100 p-4 rounded-lg">
                        <h3 class="text-lg font-medium text-gray-700 mb-2">Message Details</h3>
                        <div class="grid grid-cols-1 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Qualification</label>
                                <input type="text" value="{{ reply_qualification.qualification_title|default:'N/A' }}" class="w-full p-2 border border-gray-300 rounded-lg bg-gray-200" readonly>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Recipients</label>
                                <input type="text" value="{% for recipient in form.recipients.initial %}{{ recipient.user.full_name|default:recipient.user.email }}{% if not forloop.last %}, {% endif %}{% endfor %}" class="w-full p-2 border border-gray-300 rounded-lg bg-gray-200" readonly>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Subject</label>
                                <input type="text" value="{{ form.subject.value|default:'N/A' }}" class="w-full p-2 border border-gray-300 rounded-lg bg-gray-200" readonly>
                            </div>
                        </div>
                        {{ form.qualification.as_hidden }}
                        {{ form.recipients.as_hidden }}
                        {{ form.subject.as_hidden }}
                    </div>
                {% else %}
                    <div>
                        <label for="{{ form.qualification.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">{{ form.qualification.label }}</label>
                        {{ form.qualification }}
                        {% if form.qualification.errors %}
                            <p class="mt-1 text-sm text-red-600">{{ form.qualification.errors|join:", " }}</p>
                        {% endif %}
                    </div>
                    <div>
                        <label for="{{ form.recipients.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">{{ form.recipients.label }}</label>
                        {{ form.recipients }}
                        {% if form.recipients.errors %}
                            <p class="mt-1 text-sm text-red-600">{{ form.recipients.errors|join:", " }}</p>
                        {% endif %}
                    </div>
                    <div>
                        <label for="{{ form.subject.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">{{ form.subject.label }}</label>
                        {{ form.subject }}
                        {% if form.subject.errors %}
                            <p class="mt-1 text-sm text-red-600">{{ form.subject.errors|join:", " }}</p>
                        {% endif %}
                    </div>
                {% endif %}
                <div>
                    <label for="{{ form.body.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">{{ form.body.label }}</label>
                    {{ form.body }}
                    {% if form.body.errors %}
                        <p class="mt-1 text-sm text-red-600">{{ form.body.errors|join:", " }}</p>
                    {% endif %}
                </div>
                <div>
                    <label for="{{ form.attachment.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">{{ form.attachment.label }}</label>
                    {{ form.attachment }}
                    {% if form.attachment.errors %}
                        <p class="mt-1 text-sm text-red-600">{{ form.attachment.errors|join:", " }}</p>
                    {% endif %}
                </div>
                <div class="text-center">
                    <button type="submit" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        Send Message
                    </button>
                </div>
            </form>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
    <script>
        $(document).ready(function() {
            console.log('jQuery version:', $.fn.jquery);
            console.log('Select2 available:', typeof $.fn.select2 !== 'undefined');
            console.log('AJAX URL:', '{% url 'qualifications:get_recipients_by_qualification' %}');

            // Initialize Select2 for recipients
            try {
                $('#id_recipients').select2({
                    placeholder: "Select recipients",
                    allowClear: true,
                    width: '100%'
                });
                console.log('Select2 initialized for #id_recipients');
            } catch (e) {
                console.error('Select2 initialization error:', e);
            }

            // Ensure Select2 values are submitted
            $('#compose-message-form').on('submit', function(e) {
                $('#id_recipients').val($('#id_recipients').val());
                console.log('Form submitted with data:', $(this).serialize());
            });

            // Handle qualification change for new messages
            {% if not is_reply %}
            $('#id_qualification').on('change', function() {
                var qualificationId = $(this).val();
                console.log('Qualification selected:', qualificationId);
                if (qualificationId) {
                    $.ajax({
                        url: '{% url 'qualifications:get_recipients_by_qualification' %}',
                        type: 'GET',
                        data: { qualification: qualificationId },
                        success: function(response) {
                            console.log('Recipients response:', response);
                            var $recipientsSelect = $('#id_recipients');
                            $recipientsSelect.empty();
                            if (response.recipients && response.recipients.length > 0) {
                                response.recipients.forEach(function(recipient) {
                                    var displayText = recipient.role ? `${recipient.name} (${recipient.role})` : recipient.name;
                                    var option = new Option(displayText, recipient.id, false, false);
                                    $recipientsSelect.append(option);
                                });
                            } else {
                                console.warn('No recipients returned for qualification:', qualificationId);
                                alert('No recipients available for this qualification.');
                            }
                            $recipientsSelect.trigger('change');
                        },
                        error: function(xhr) {
                            console.error('Failed to load recipients:', xhr.status, xhr.responseText);
                            try {
                                var errorMsg = JSON.parse(xhr.responseText).error || 'Unknown error';
                                alert('Failed to load recipients: ' + errorMsg);
                            } catch (e) {
                                alert('Failed to load recipients: Server error (Status: ' + xhr.status + ').');
                            }
                        }
                    });
                } else {
                    $('#id_recipients').empty().trigger('change');
                }
            });

            // Trigger change if qualification is pre-selected
            var $qualificationSelect = $('#id_qualification');
            if ($qualificationSelect.length && $qualificationSelect.val()) {
                console.log('Pre-selected qualification:', $qualificationSelect.val());
                $qualificationSelect.trigger('change');
            } else {
                console.log('No pre-selected qualification or select element not found');
            }
            {% endif %}
        });
    </script>
{% endblock %}